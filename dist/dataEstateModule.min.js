//Version 0.4.0 Removed incompleted code and moved mdeMenu
//CONSTANTS
//Estate Service
// v0.1.6: assets added categories as dictionary. 
// v0.3.6
// v0.1.2: taxonomy - TODO: Get from API. 
// v0.2.4: Multimedia Merge
// v0.1.2: HELPER
// v0.2.2: Require CATEGORY ICONS
//DE-LINK FORMAT CHANGED! Won't work with md-button
//v0.2.8 Immitation of angular-material tooltip
//v0.4 - Added min length and onSelect function
//v0.3.4
//v0.3.7
//v0.3.7 - TODO: Revisit how "reset is used";
//v0.3.9 - Tags
//FILTERS
var de=angular.module("dataEstateModule",[])
de.constant("VERSION",.4),de.provider("DeApi",function(){this.apiUrl="https://api.dataestate.net/v2",this.apiKey="",this.authType="api-key",this.oauthData={},this.setApi=function(e){this.apiUrl=e},this.setApiKey=function(e){this.apiKey=e},this.setToken=function(e){this.oauthData.token=e},this.setAuthType=function(e){["token","api-key"].indexOf(e)>=0&&(this.authType=e)},this.getAuthType=function(){return this.authType},this.$get=function(e){return this.get=function(t,n){if(void 0!==t){var i={url:this.apiUrl+t,method:"GET"}
return"api-key"==this.authType?void 0===n||n.hasOwnProperty("api_key")||(n.api_key=this.apiKey):"token"==this.authType&&(i.headers={Authorization:"Bearer "+this.oauthData.token}),i.params=n,e(i)}},this.put=function(t,n){if(void 0!==t){var i={}
return"api-key"==this.authType?i["API-KEY"]=this.apiKey:"token"==this.authType&&(i.Authorization="Bearer "+this.oauthData.token),console.log(this.apiUrl+t),console.log(n),console.log(i),e({url:this.apiUrl+t,method:"PUT",data:n,headers:i})}},this.post=function(t,n){if(void 0!==t){var i={}
return"api-key"==this.authType?i["API-KEY"]=this.apiKey:"token"==this.authType&&(i.Authorization="Bearer "+this.oauthData.token),e({url:this.apiUrl+t,method:"POST",data:n,headers:i})}},this.delete=function(t){if(void 0!==t){var n={}
return"api-key"==this.authType?n["API-KEY"]=this.apiKey:"token"==this.authType&&(n.Authorization="Bearer "+this.oauthData.token),e({url:this.apiUrl+t,method:"DELETE",headers:n})}},this}}),de.factory("DeEstates",function(e){return{data:function(t,n){void 0==n&&(n="")
var i="/estates/data/"+n
return e.get(i,t)},update:function(t,n,i,a,o){var r="/estates/data/"+t,d={data:n}
return void 0!==i&&"english"!=i&&(d.language=i),void 0!==a&&null!==a&&(d.remove=a),void 0!==o&&null!==o&&(d.add=o),e.put(r,d)},create:function(t,n){var i={data:n}
return e.post("/estates/data/",i)},remove:function(t){var n="/estates/data/"+t
return e.delete(n,postData)}}}),de.factory("DeAssets",function(e){var t=""
return{setEstate:function(e){t=e},getEstate:function(){return t},data:function(t,n){void 0==n&&(n="")
var i="/assets/data/"+n
return e.get(i,t)},timetable:function(t){return e.get("/assets/timetable/",t)},flights:function(t){return e.get("/assets/flights/",t)},update:function(t,n,i,a,o){var r="/assets/data/"+t,d={data:n}
return void 0!==i&&(d.language=i),void 0!==a&&null!==a&&(d.remove=a),void 0!==o&&null!==o&&(d.add=o),e.put(r,d)},create:function(n,i,a){a.hasOwnProperty("type")||(a.type=i),void 0===n&&(n=t)
var o={data:a,estate_id:n}
return e.post("/assets/data/",o)},remove:function(t){var n="/assets/data/"+t
return e.delete(n)}}}),de.factory("DeUsers",function(e,t){var n=null
return{data:function(i){var a=t.defer()
return 1==i||null===n?(console.log("Getting user"),e.get("/users/data/").then(function(e){n=e.data,a.resolve(n)},function(e){a.reject(e)})):a.resolve(n),a.promise}}}),de.factory("DeTaxonomy",function(e){var t=[{type:"LANDMARK",description:"Landmark"},{type:"EDUCATION",description:"Educational"},{type:"FOODDRINK",description:"Food and Drink"},{type:"MUSICAL",description:"Musical Performance"},{type:"CEREMONY",description:"Ceremony"},{type:"SPORT",description:"Sports Event"},{type:"PERFORMANCE",description:"Performances"},{type:"PARADE",description:"March and Parade"},{type:"CULTURAL",description:"Cutural"},{type:"ACTIVITY",description:"Activities"},{type:"MEDITATION",description:"Meditation"},{type:"PHOTOGRAPHY",description:"Photography Event"},{type:"TALK",description:"Talks"},{type:"FORUM",description:"Forums"},{type:"FOOD",description:"Food"},{type:"DESSERT",description:"Snacks and Desserts"},{type:"DRINK",description:"Drinks"},{type:"SHOP",description:"Shops"},{type:"INFO",description:"Information"},{type:"VOLUNTEER",description:"Volunteers"},{type:"DISPLAY",description:"Art and Display"},{type:"SERVICE",description:"Services"}],n=[{id:"BNELETTER",name:"Brisbane Letters",loc:[-27.474147,153.020482]},{id:"QC",name:"Queensland Conservatorium",loc:[-27.4768193,153.0208075]},{id:"LIANA",name:"Liana Lounge",loc:[-27.475902,153.021213]},{loc:[-27.4706487,153.0170457],id:"GOMA",name:"GOMA (Gallery of Modern Art)"},{id:"CF",name:"Cultural Forecourt",loc:[-27.4739896,153.0203686]},{loc:[-27.4748418,153.0212796],id:"RB",name:"Riverbank"},{loc:[-27.476474,153.021173],name:"Lumbini Garden",id:"LG"},{loc:[-27.4771943,153.0217732],id:"NB",name:"No Boundaries"},{loc:[-27.476186,153.021666],name:"Rainforest Green",id:"RG"},{id:"CMP",name:"The South Bank Piazza",loc:[-27.4769716,153.0214888]},{id:"PAS",loc:[-27.474771,153.0209563],name:"Performing Arts Stage"}],i={ACCOMM:"Accommodation",APP:"Application",ATTRACTION:"Attraction",COMPANY:"Company",DESTINFO:"Destination Information",EVENT:"Event",GROUP:"Group",HIRE:"Hire",INFO:"Information Services",JOURNEY:"Journey",ORG:"Organisation",RESTAURANT:"Food and Drink",TOUR:"Tour",TRANSPORT:"Transport"},a=[{id:"in",name:"Instagram"},{id:"fb",name:"Facebook"},{id:"li",name:"LinkedIn"},{id:"tw",name:"Twitter"},{id:"yt",name:"YouTube"}]
return{subtypes:function(){return t},locations:function(){return n},categories:function(){return i},accreditations:function(){return e.get("/taxonomy/data/ACCREDITN",{})},social:function(){return a},data:function(t,n){void 0==n&&(n="")
var i="/taxonomy/data/"+n
return e.get(i,t)},update:function(t,n,i,a,o){var r="/taxonomy/data/"+t,d={data:n}
return void 0!==i&&(d.language=i),void 0!==a&&null!==a&&(d.remove=a),void 0!==o&&null!==o&&(d.add=o),e.put(r,d)},create:function(t,n){n.hasOwnProperty("type")||(n.type=t)
var i={data:n}
return e.post("/taxonomy/data/",i)},remove:function(t){var n="/taxonomy/data/"+t
return e.delete(n)}}}),de.factory("DeMultimedia",function(e,t){var n=[]
return{data:function(t,n){void 0==t&&(t="")
var i="/multimedia/"+t
return e.get(i,n)},update:function(t,n,i,a){var o="/multimedia/"+t,r={data:n}
return void 0!==i&&null!==i&&(r.remove=i),void 0!==a&&null!==a&&(r.add=a),e.put(o,r)},upload:function(n,i,a,o){var r="/multimedia/"+n,d=new FormData
if(d.append("file",i,i.name),d.append("estate",n),void 0!==o)for(var s in o)d.append(s,o[s])
var u={"Content-Type":void 0}
"api-key"==e.authType?u["API-KEY"]=e.apiKey:"token"==e.authType&&(u.Authorization="Bearer "+e.oauthData.token)
var c={url:e.apiUrl+r,method:"POST",data:d,headers:u,transformRequest:function(e,t){return e}}
return void 0!==a&&""!=a&&(c.uploadEventHandlers=a),t(c)},remove:function(t,n){var i="/multimedia/"+t+"/"+n
return e.delete(i)},loadLast:function(){return n}}}),de.factory("DeHelper",function(){function e(i){var a=JSON.parse(JSON.stringify(i))
if(t(a))return null
switch(n(a)){case"Array":for(var o in a)t(a[o],!0)?a=a.splice(o,1):(a[o]=e(a[o]),void 0!=a[o]&&null!==a[o]||a.splice(o,1))
break
case"Object":for(var o in a)t(a[o],!0)?delete a[o]:(a[o]=e(a[o]),void 0!=a[o]&&null!==a[o]||delete a[o])}return t(a)?null:a}function t(e,i){var a=!1
switch(i=void 0===i,n(e)){case"Array":if(e.length<=0)a=!0
else{a=!0
for(var o in e)t(e[o])||(a=!1)}break
case"Object":Object.keys(e).length<=0&&(a=!0)
break
case"String":i&&""==e&&(a=!0)
break
default:void 0===e&&(a=!0)}return a}function n(e){var t=Object.prototype.toString.call(e)
return void 0!==t?t.replace("[object ","").replace("]",""):"undefined"}function i(e,t,n,i){var a={}
void 0!==i&&(a=i),void 0!==t&&""!==t?(e.hasOwnProperty(t)||(e[t]=[]),1==n?e[t].unshift(a):e[t].push(a)):1==n?e.unshift(a):e.push(a)}function a(e,t,n){var i=angular.copy(n)
i.hasOwnProperty("id")&&(i.id=i.id+"-copy"),void 0===t||"null"==t?e.splice(0,0,i):e.splice(t,0,i)}function o(e,t,n){void 0===t||"null"==t?void 0!==n?e[n].splice(0):e.splice(0):void 0!==n?e[n].splice(t,1):e.splice(t,1)}function r(e,t,n,i){if(void 0==i){var a=void 0==t?"temp":t
i=getTempId(t)}if(void 0!==t){for(e.hasOwnProperty(t)||(e[t]={});e[t].hasOwnProperty(i);)i=getTempId(a)
e[t][i]="Array"==n?[]:{}}else{for(;e.hasOwnProperty(i);)i=getTempId(a)
e[i]="Array"==n?[]:{}}}return{inArray:function(e,t,n){if(void 0==t)return!1
if(!Array.isArray(e)){if("object"==typeof e){for(var i in t)if(angular.equals(t[i],e))return!0
return!1}if(void 0!==n)for(var i in t)if(t[i][n]==e)return!0
return t.indexOf(e)>=0}for(var i in t)for(var a in e)if(console.log("Comparing "+e[a]+" and "+t[i]),e[a]==t[i])return!0},getQueryParameter:function(e){var t=document.location.search.replace(/(^\?)/,"").split("&").map(function(e){return e=e.split("="),this[e[0]]=e[1],this}.bind({}))[0]
return void 0===e?t:t[e]},getURLPaths:function(e){var t=window.location.pathname.split("/")
if(t.shift(),-1==e){var n=t.pop()
return""==n&&(n=t.pop()),n}return void 0!==e?t[e]:t},getDiff:function(t,i,a){var o={},r={}
if("Array"==n(i)&&(o=[]),"object"!=typeof i||"object"!=typeof t||angular.equals(t,i))return o
var d=angular.copy(i)
for(var s in d)t.hasOwnProperty(s)&&angular.equals(t[s],d[s])||(d[s]=e(d[s]),null!==d[s]&&(o[s]=d[s]))
if(1==a){for(var u in t)d.hasOwnProperty(u)&&null!=d[u]||(r[u]="")
return{changed:o,removed:r}}return o},isEmpty:t,model:{addItem:i,copyItem:a,removeItem:o,addObject:r}}}),de.provider("DeIcons",function(){this.categoryURL="http://warehouse.dataestate.com.au/DE/categories/",this.setCategoryURL=function(e){this.categoryURL=e},this.$get=function(){return this.categoryIcon=function(e){if(void 0!==e)return this.categoryURL+e+".svg"},this}}),de.directive("deLink",function(){return{scope:{deLink:"=?deLink",apiAction:"&?deApiAction",internalAction:"&?deInternalAction",linkOptions:"=?deLinkOptions"},transclude:"element",link:function(e,t,n,i){e.deLink
if(void 0!==e.deLink.type)if(console.log("Link type: "+e.deLink.type),"api"==e.deLink.type)t.on("click",function(){e.apiAction({$elem:t,endpoints:e.deLink.endpoints,params:e.deLink.params})})
else if("internal"==e.deLink.type)t.on("click",function(){e.internalAction({$elem:t,link:e.deLink.link})})
else{if(void 0!==e.linkOptions&&void 0!==e.linkOptions.targets)for(var a in e.linkOptions.targets)a==e.deLink.type&&t.attr("target",e.linkOptions.targets[a])
t.attr("href",e.deLink.link)}}}}),de.directive("deJson",function(e){return{restrict:"A",scope:{jsonValue:"=deJson"},link:function(e,t,n){if(void 0!==e.jsonValue){var i=JSON.stringify(e.jsonValue)
t.text(i)}t.on("change",function(t){e.$apply(function(){try{e.jsonValue=JSON.parse(t.currentTarget.value)}catch(e){alert(t.currentTarget.value+" is not a valid JSON string. Changes not saved.")}})})}}}),de.directive("deDateModel",function(){return{restrict:"A",scope:{dateObj:"=deDateModel"},link:function(e,t,n){if(void 0!==e.dateObj)if("string"==typeof e.dateObj){var i=e.dateObj.split("+")[0]
t.val(i),console.log(i)}else{console.log(e.dateObj.getTimezoneOffset())
var a=e.dateObj.toISOString().split("Z")[0]
console.log(a),t.val(a)}t.on("change",function(n){e.$apply(function(){console.log(t.val()),""==t.val()?console.log("Nothing yet..."):e.dateObj=t.val()})})}}}),de.directive("ngEnter",function(){return function(e,t,n){t.bind("keydown keypress",function(t){13===t.which&&(e.$apply(function(){e.$eval(n.ngEnter)}),t.preventDefault())})}}),de.directive("deAnimateEnd",function(e){return{scope:{deAnimateEnd:"&"},link:function(t,n,i){e.on("leave",n,function(){t.deAnimateEnd({$scope:t,$element:n})})}}}),de.directive("deTooltip",function(e){return{link:function(e,t,n){var i=t.parent(),a=["position:absolute","z-index:100000"]
t.addClass("de-tooltip")
var o=a.join(";")
t.parent().on("mouseover",function(e){t.attr("style",o),t.appendTo(i.parent())}),t.parent().on("mouseout",function(){t.remove()}),t.remove()}}}),de.directive("jqAutocomplete",function(){return{require:"ngModel",scope:{source:"=jqAutoSource",onCreate:"&?jqOnCreate",onSelect:"&?jqOnSelect",onFocus:"&?jqOnFocus",jqShowfield:"=",minLength:"=jqMinLength"},link:function(e,t,n,i){t.autocomplete({minLength:void 0!==e.minLength||isNaN(e.minLength)?e.minLength:2,source:e.source,create:function(n,i){void 0!==e.onCreate&&e.onCreate({$event:n,element:t})},focus:function(e,n){e.preventDefault(),t.val(n.item?n.item.label:"")},select:function(a,o){a.preventDefault(),i.$setViewValue(o.item.value),t.val(o.item?o.item.label:""),"value"==n.jqShowfield?t.val(o.item?o.item.value:""):t.val(o.item?o.item.label:""),void 0!==e.onSelect&&"function"==typeof e.onSelect&&(e.onSelect({$event:a,$ui:o}),t.val(""))},change:function(e,n){e.preventDefault(),null===n.item?(t.val(""),i.$setViewValue(null)):i.$setViewValue(n.item.value)}}).data("ui-autocomplete")._renderItem=function(e,t){var n=String(t.label).replace(new RegExp(this.term,"ig"),'<span class="ui-autocomplete-highlight">'+this.term+"</span>")
return $('<li class="ui-menu-item"></li>').data("item.autocomplete",t).append('<div class="ui-menu-item-wrapper">'+n+"</div>").appendTo(e)}}}}),de.directive("deCurrency",function(){return{restrict:"E",scope:{money:"=ngModel"},link:function(e,t,n){e.editing=!1,e.toggleEdit=function(t){e.editing=t}},template:'<input type="number" ng-model="money" ng-show="editing" ng-blur="toggleEdit(false)"><span ng-bind="money | currency" ng-hide="editing" ng-click="toggleEdit(true)"></span>'}}),de.factory("DeChangeRegister",function(e){var t={},n={},i={},a={}
return{registerTracking:function(e,t,o,r){void 0!==e&&void 0!==t&&void 0!==o&&(void 0===n[e]&&(n[e]={}),void 0===i[e]&&(i[e]={}),n[e][t]=angular.copy(o),i[e][t]=o,void 0!==r&&(void 0===a[e]&&(a[e]={}),a[e][t]=r))},commitTracking:function(e,o){if(void 0===e)n={},t={}
else{if(void 0!==i[e])if(void 0!==o&&void 0!==i[e][o])n[e][o]=angular.copy(i[e][o]),void 0!==a[e]&&void 0!==a[e][o]&&(console.log(a[e][o].DeChangeReset),"function"==typeof a[e][o].DeChangeReset&&a[e][o].DeChangeReset())
else if(n[e]=angular.copy(i[e]),void 0!==a[e])for(var r in a[e])"function"==typeof a[e][r].DeChangeReset&&a[e][r].DeChangeReset()
void 0!==t[e]&&void 0!==o&&delete t[e][o]}},trackChanges:function(i,a,o){if(void 0!==n[i]&&void 0!==n[i][a]){var r=e.getDiff(n[i][a],o,!0)
return e.isEmpty(r.changed)&&e.isEmpty(r.removed)?(void 0!==t[i]&&delete t[i][a],!1):(void 0===t[i]&&(t[i]={}),t[i][a]=r,!0)}},getChanges:function(e,n){return void 0!==e&&void 0!==t[e]?void 0===n||void 0===t[e][n]?t[e]:t[e][n]:null},getOriginals:function(e,t){return void 0!==e&&void 0!==n[e]?void 0!==t&&void 0!==n[e][t]?n[e][t]:n[e]:n},hasChanged:function(e,t){var n=!0
return void 0!==e?void 0===changeSet[e]?n=!1:void 0!==t&&void 0===changeSet[e][t]&&(n=!1):n=!1,n}}}),de.directive("deTrackChanges",function(e){return{scope:{trackModel:"=deTrackChanges",trackName:"=deTrackName",trackId:"=?deTrackId"},link:function(t,n,i){var a=void 0===t.trackId?t.$id:t.trackId
e.registerTracking(t.trackName,a,t.trackModel,t),t.$watch("trackModel",function(i,o){e.trackChanges(t.trackName,a,i)?n.addClass("data-changed"):n.removeClass("data-changed")},!0),t.DeChangeReset=function(){n.removeClass("data-changed")}}}}),de.directive("deTagInput",function(){return{scope:{tags:"=ngModel",delimiter:"=?deTagDelimiter",maxLength:"=?deTagMax"},link:function(e,t,n){e.maxSize=void 0===e.maxLength?5:intVal(e.maxLength)
var i=void 0===e.delimiter?",":e.delimiter
e.$watch("tagText",function(t,n){if(void 0!==t&&t[t.length-1]==i){void 0==e.tags&&(e.tags=[])
var a=n.trim().replace(" ","-")
e.tags.indexOf(a)<0&&e.tags.length<e.maxSize&&e.tags.push(a),e.tagText=""}}),e.canAddTags=function(){return void 0===e.tags||e.tags.length<e.maxSize},e.deleteTag=function(t){e.tags.splice(t,1)}},template:'<div class="tags-container"><div class="tags" ng-repeat="tag in tags"><span type="tag-text" ng-bind="tag"></span><button class="tags-delete material-icons" ng-click="deleteTag($index)">close</button></div><div class="tags-input"><input class="tag-text" ng-model="tagText" ng-show="canAddTags()" placeholder="new tag"><span class="tags-message" ng-hide="canAddTags()" ng-cloak>Max. tags ({{maxSize}}) reached!</span></div></div>'}}),de.filter("validity",function(){return function(e){return isNaN(e.charAt(0))?(e=e.replace("M","1 month"),e=e.replace("D","1 day"),e=e.replace("Y","1 year")):(e=e.replace("M"," months"),e=e.replace("D"," days"),e=e.replace("Y"," years")),e}}),de.filter("filterId",function(){return function(e,t,n){for(var i in e)if(e[i].id==t)return void 0===n?e[i]:e[i][n]
return""}})
