//Version 0.5.3 //Tag Implementation
//REQUIRE DE-Module. 
de.provider("DeGalleryControl",function(){this.galleryId="",this.showGallery=!1,this.triggerScope,this.$get=function(){return this.isGalleryShown=function(){return this.showGallery},this.toggleGallery=function(e){return this.showGallery=1==e,this.showGallery},this.setTriggerScope=function(e){this.triggerScope=e},this}}),de.directive("deGalleryTrigger",function(e){return{scope:{galleryModel:"=?deGalleryModel",galleryType:"=?deModelType",onImgSelect:"&onSelectImage"},link:function(t,a,i){a.on("click",function(){e.setTriggerScope(t),e.toggleGallery(!0),t.$apply()})}}}),de.directive("deGallery",function(){return{restrict:"E",scope:{gid:"@galleryId",showGallery:"=galleryShow",onGalleryOpen:"&",onGalleryClose:"&",onSelectImage:"&"},controller:function(e,t,a,i){var l=e.gid
e.imgTabActive=!0,e.fileTabActive=!1,e.fileQueue={},e.tagFilters=[],e.shouldShow=function(){return i.isGalleryShown()},e.toggleTags=function(t){var a=e.tagFilters.indexOf(t)
a<0?e.tagFilters.push(t):(e.tagFilters.splice(a,1),console.log(a))},e.tagActive=function(t){return e.tagFilters.indexOf(t)>=0},e.filtered=function(t){if(void 0!==e.nameFilter&&""!=e.nameFilter)return t.name.indexOf(e.nameFilter)>=0||void 0!==t.alt&&t.alt.indexOf(e.nameFilter)>=0
if(e.tagFilters.length<=0)return!0
if(void 0===t.tags)return!1
for(var a in t.tags)if(e.tagFilters.indexOf(t.tags[a])>=0)return!0
return!1},e.openGallery=function(){i.toggleGallery(!0)},e.closeGallery=function(){i.toggleGallery(!1)},e.loadImages=function(){a.data(l).then(function(t){e.imageData=t.data,e.imageTags=[]
for(var a in t.data)if(void 0!==t.data[a].tags)for(var i in t.data[a].tags)e.imageTags.indexOf(t.data[a].tags[i])<0&&e.imageTags.push(t.data[a].tags[i])
console.log(e.imageTags)},function(e){console.log("Error found")})},e.selectImage=function(){i.triggerScope.onImgSelect({$imgContent:e.selectedImg})
var t=i.triggerScope,a="object"
if(void 0!==t.galleryType&&(a=t.galleryType),t.hasOwnProperty("galleryModel")){var l={id:e.selectedImg.id,name:e.selectedImg.name,extension:e.selectedImg.extension,estate:e.selectedImg.estate,mime_type:e.selectedImg.mime_type,width:e.selectedImg.width,height:e.selectedImg.height,orientation:e.selectedImg.orientation,sizes:e.selectedImg.sizes,path:e.selectedImg.path,bytes:e.selectedImg.bytes,update_date:e.selectedImg.update_date}
switch(e.selectedImg.hasOwnProperty("alt")&&(l.alt=e.selectedImg.alt),e.selectedImg.hasOwnProperty("author")&&(l.author=e.selectedImg.author),e.selectedImg.hasOwnProperty("tags")&&(l.tags=e.selectedImg.tags),e.selectedImg.hasOwnProperty("credit_url")&&(l.credit_url=e.selectedImg.credit_url),a){case"array":console.log(t.galleryModel),void 0==t.galleryModel&&(t.galleryModel=[]),t.galleryModel.push(l)
break
case"object":default:t.galleryModel=l}}i.toggleGallery(!1)},e.saveImageMeta=function(){var t={data:{}}
if(e.selectedImg.hasOwnProperty("alt")&&(t.data.alt=e.selectedImg.alt),e.selectedImg.hasOwnProperty("author")&&(t.data.author=e.selectedImg.author),e.selectedImg.hasOwnProperty("tags")){t.data.tags=e.selectedImg.tags
for(var i in e.selectedImg.tags)e.imageTags.indexOf(e.selectedImg.tags[i])<0&&e.imageTags.push(e.selectedImg.tags[i])}e.selectedImg.hasOwnProperty("credit_url")&&(t.data.credit_url=e.selectedImg.credit_url),console.log(e.selectedImg.id),a.update(l+"/"+e.selectedImg.id,t.data).then(function(e){console.log(e.data)})},e.activateTab=function(t){"imgTab"==t?(e.imgTabActive=!0,e.fileTabActive=!1):(e.imgTabActive=!1,e.fileTabActive=!0)},e.deleteFile=function(t){var i=e.imageData[t]
i.removing=!0,a.remove(l,i.id).then(function(a){e.imageData.splice(t,1)},function(e){})},e.previewImg=function(t){e.selectedImg=t},e.addFile=function(t){if(void 0!==t){var a={status:"PENDING",file:t},i=new Date,l=i.getTime().toString()
a.add_ts=l,e.fileQueue[l]=a,e.$apply()}},e.removeFile=function(t){console.log("Removing file "+t+" from queue..."),delete e.fileQueue[t]},e.uploadFiles=function(){for(var t in e.fileQueue){e.fileQueue[t]
e.uploadFile(e.fileQueue[t]).then(function(t){var a=t.data.uploaded,i=a.add_ts
void 0!==a&&e.removeFile(i),Object.keys(e.fileQueue).length<=0&&(e.loadImages(),e.activateTab("imgTab"))})}},e.uploadFile=function(e){e.isloading=!0
var t={progress:function(t){e.progress=t,e.progress.percentage=t.loaded/t.total}},i={add_ts:e.add_ts}
return void 0!==e.meta&&(e.meta.hasOwnProperty("alt")&&(i.alt=e.meta.alt),e.meta.hasOwnProperty("author")&&(i.author=e.meta.author),e.meta.hasOwnProperty("tags")&&(i.tags=e.meta.tags.join(",")),e.meta.hasOwnProperty("credit_url")&&(i.credit_url=e.meta.credit_url)),a.upload(l,e.file,t,i)}},template:galleryTemplate}}),de.directive("deBindFiles",function(){return{scope:{onChange:"&deBindFiles"},link:function(e,t,a){t.on("change",function(){if(void 0!==e.onChange&&void 0!==t[0].files)for(var a in t[0].files){console.log("Adding file: "+a)
var i=t[0].files[a]
i instanceof Blob&&e.onChange({file:t[0].files[a]})}})}}}),de.directive("dePreviewFile",function(){return{scope:{uploadFile:"=dePreviewFile"},link:function(e,t,a){var i=new FileReader
i.onload=function(a){var i="",l=e.uploadFile.type.split("/"),n=l[0],d=l[1]
switch(n){case"image":i='<img class="preview preview-img" src="'+a.target.result+'" alt="preview">'
break
default:i='<div class="preview preview-'+d+'">'+d+" file</div>"}t.append(i)},i.readAsDataURL(e.uploadFile)}}}),de.filter("bytes",function(){return function(e,t){if(isNaN(parseFloat(e))||!isFinite(e))return"-"
void 0===t&&(t=1)
var a=["bytes","kB","MB","GB","TB","PB"],i=Math.floor(Math.log(e)/Math.log(1024))
return(e/Math.pow(1024,Math.floor(i))).toFixed(t)+" "+a[i]}})
var galleryTemplate='<div class="gallery-mask" ng-show="shouldShow()" ng-click="closeGallery()"></div><div class="gallery-container" ng-init="loadImages()" ng-attr-id="gallery-{{id}}" ng-show="shouldShow()"><header class="gallery-header"><h2>Choose an Image</h2><button type="button" class="btn-op btn-close" ng-click="closeGallery()"></button></header><nav class="gallery-nav nav-tabs"><button type="button" class="btn-tab" ng-click="activateTab(\'imgTab\')" ng-class="{active : imgTabActive}">Gallery</button><button type="button" class="btn-tab" ng-click="activateTab(\'fileTab\')" ng-class="{active : fileTabActive}">Upload</button></nav><section class="gallery-content"><div class="gallery-tab img-tab" ng-show="imgTabActive"><div class="gallery-img-content"><div class="gallery-filters"><input type="text" ng-model="nameFilter" class="name-filter" placeholder="filter images by name"><div class="tags-filter tags-container"><div class="tag-filter-container" ng-repeat="tag in imageTags | orderBy"><button type="button" class="tags" ng-bind="tag" ng-click="toggleTags(tag)" ng-class="{\'active\':tagActive(tag)}"></button></div></div></div><div class="gallery-img-container" ng-repeat="imgObj in imageData" ng-show="filtered(imgObj)"><button type="button" class="btn-op btn-remove" ng-click="deleteFile($index)"></button><div class="gallery-img" ng-click="previewImg(imgObj)"><img ng-src="{{imgObj.sizes.thumb.path}}" ng-if="imgObj.type==\'image\'" ng-class="{\'portrait-img\':imgObj.orientation==\'portrait\'}"><i class="material-icons" ng-if="imgObj.type!=\'image\'">insert_drive_file</i><span ng-bind="imgObj.name" ng-if="imgObj.type!=\'image\'"></span></div><div class="img-remove" ng-if="imgObj.removing"></div></div></div><div class="gallery-preview-pane" ng-show="selectedImg"><div class="gallery-img-container"><div class="gallery-img" ng-class="{\'portrait-img\':selectedImg.orientation==\'portrait\', \'square-img\':selectedImg.orientation==\'square\'}"><img ng-src="{{selectedImg.sizes.medium.path}}" ng-if="selectedImg.type==\'image\'" ng-class="{\'portrait-img\':selectedImg.orientation==\'portrait\', \'square-img\':selectedImg.orientation==\'square\'}"><i class="material-icons" ng-if="selectedImg.type!=\'image\'">insert_drive_file</i><span ng-bind="selectedImg.name" ng-if="selectedImg.type!=\'image\'"></span></div></div><div class="gallery-img-meta"><dl><dt>Image Name: </dt><dd><span ng-bind="selectedImg.name"></span></dd><dt>Extension: </dt><dd><span ng-bind="selectedImg.extension"></span></dd><dt>Orientation:</dt><dd><span ng-bind="selectedImg.orientation"></span></dd><dt>Path: </dt><dd><span ng-bind="selectedImg.path"></span></dd><dt>Alt Text:</dt><dd><input type="text" ng-model="selectedImg.alt" placeholder="Alt text"></dd><dt>Tags:</dt><dd><div de-tag-input ng-model="selectedImg.tags"></div></dd><dt>Photographer:</dt><dd><input type="text" ng-model="selectedImg.author" placeholder="Photographer"></dd><dt>Credit Link:</dt><dd><input type="text" ng-model="selectedImg.credit_url" placeholder="Image credit\'s URL. "></dd></dl></div><div class="gallery-img-action"><button type="button" class="btn-select" ng-click="selectImage()">Select image</button><button type="button" class="btn-submit" ng-click="saveImageMeta()">Save image info</button></div></div></div><div class="gallery-tab file-tab" ng-show="fileTabActive"><div class="gallery-file-content"><div class="gallery-file-dropzone"></div><div class="gallery-file-container" ng-repeat="(fileKey,fileObj) in fileQueue"><div class="gallery-img-container"><button type="button" class="btn-op btn-remove" ng-click="removeFile(fileKey)"></button><div class="gallery-img"><div de-preview-file="fileObj.file"></div><div class="gallery-file-progress" ng-if="fileObj.isloading"><span>Uploading</span></div></div></div><div class="gallery-img-meta"><dl><dt>Image Name: </dt><dd><label class="file-name" ng-bind="fileObj.file.name"></label></dd><dt>File size: </dt><dd><span class="file-size" ng-bind="fileObj.file.size | bytes"></span></dd><dt>Alt Text:</dt><dd><input type="text" ng-model="fileQueue[fileKey].meta.alt" placeholder="Alt text"></dd><dt>Tags:</dt><dd><div de-tag-input ng-model="fileQueue[fileKey].meta.tags"></div></dd><dt>Photographer:</dt><dd><input type="text" ng-model="fileQueue[fileKey].meta.author" placeholder="Photographer"></dd><dt>Credit Link:</dt><dd><input type="text" ng-model="fileQueue[fileKey].meta.credit_url" placeholder="Image credit\'s URL. "></dd></dl></div></div></div><div class="gallery-file-action"><label for="upload-file" class="btn-upload">Choose Files</label><input type="file" id="upload-file" name="upload-file" de-bind-files="addFile(file)" multiple><button type="button" class="btn-upload-all" ng-click="uploadFiles()">Upload All</button></div></div></section></div>'
